package de.unileipzig.irpact.util.gnuplot.builder;

import de.unileipzig.irpact.util.script.BuilderSettings;

import java.time.LocalDateTime;

/**
 * @author Daniel Abitz
 */
public final class GnuPlotFactory {

    public static final StringSettings SETTINGS = new StringSettings();

    private GnuPlotFactory() {
    }

    private static Comment getAutoGenerated() {
        return new Comment("automatic generated gnuplot script (" + LocalDateTime.now() + ")");
    }

    private static String getUsageComment(int usageFlag) {
        switch (usageFlag) {
            case BuilderSettings.USAGE_ARG0:
                return "usage: gnuplot <scirpt name>";

            case BuilderSettings.USAGE_ARG2:
                return "usage: gnuplot -c <script name> <input file> <output file>";

            case BuilderSettings.NO_USAGE:
            default:
                return null;
        }
    }

    private static void addUsageComment(GnuPlotBuilder builder, int usageFlag) {
        String comment = getUsageComment(usageFlag);
        if(comment != null) {
            builder.addComment(comment);
        }
    }

    private static GnuPlotBuilder newBuilder() {
        GnuPlotBuilder builder = new GnuPlotBuilder();
        builder.setSettings(SETTINGS);
        return builder;
    }

    private static String getString(BuilderSettings settings, String str) {
        if(settings.escapeSpecialCharacters()) {
            return GnuPlotBuilder.escapeUnderscore(str);
        } else {
            return str;
        }
    }

    //=========================
    //line chart
    //=========================

    public static GnuPlotBuilder lineChart0(BuilderSettings settings) {
        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: line chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataLinesPoints();
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        if(settings.hasGrpLab()) builder.setLegendOutsideRightTop(getString(settings, settings.nonNull().getGrpLab()));
        else builder.setLegendOutsideRightTop();
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.printUnknown();
        builder.plotRawSpecialLinePlot(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()), (int) settings.allowNull().getLineWidthDouble());
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.setXRange(settings.nonNull().getXMin(), settings.nonNull().getXMax());
        builder.setYRange(settings.nonNull().getYMin(), settings.nonNull().getYMax());
        builder.replot();
        return builder;
    }

    public static GnuPlotBuilder interactionLineChart0(BuilderSettings settings) {
        SpecialInteractionLinePlotCommand plot = new SpecialInteractionLinePlotCommand();
        plot.setKeyTitle0(settings.nonNull().getDistinctLab());
        plot.setKeyTitle1(settings.nonNull().getGrpLab());
        plot.setDashtype0(1);
        plot.setDashtype1(2);
        plot.setDashtype0Label(settings.nonNull().getDistinct0Label());
        plot.setDashtype1Label(settings.nonNull().getDistinct1Label());
        plot.setData(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()));
        plot.setLinewidth((int) settings.allowNull().getLineWidthDouble());

        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: special line chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataLinesPoints();
        builder.setLegendOutsideRightTop();
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.printUnknown();
        builder.add(plot);
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.setXRange(settings.nonNull().getXMin(), settings.nonNull().getXMax());
        builder.setYRange(settings.nonNull().getYMin(), settings.nonNull().getYMax());
        builder.replot();
        return builder;
    }

    public static GnuPlotBuilder interactionLineChartForVersionLess528(BuilderSettings settings) {
        SpecialInteractionLinePlotCommandForVersionLess528 plot = new SpecialInteractionLinePlotCommandForVersionLess528();
        plot.setKeyTitle0(settings.nonNull().getDistinctLab());
        plot.setKeyTitle1(settings.nonNull().getGrpLab());
        plot.setDashtype0(1);
        plot.setPointtype0(1);
        plot.setDashtype1(2);
        plot.setPointtype1(2);
        plot.setDashtype0Label(settings.nonNull().getDistinct0Label());
        plot.setDashtype1Label(settings.nonNull().getDistinct1Label());
        plot.setData(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()));
        plot.setLinewidth((int) settings.allowNull().getLineWidthDouble());
        plot.setNumberOfEntries(settings.nonNull().getNumberOfEntries());

        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: special line chart v1 for gnuplot version < 5.2.8");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataLinesPoints();
        builder.setLegendOutsideRightTop();
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.printUnknown();
        builder.add(plot);
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.setXRange(settings.nonNull().getXMin(), settings.nonNull().getXMax());
        builder.setYRange(settings.nonNull().getYMin(), settings.nonNull().getYMax());
        builder.replot();
        return builder;
    }

    //=========================
    //stacked bar
    //=========================

    public static GnuPlotBuilder stackedBarChart0(BuilderSettings settings) {
        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: stacked bar chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataHistograms();
        builder.setStyleHistrogramRowStacked();
        builder.setFillSolid();
        builder.setBoxWidthAbsolute(settings.allowNull().getBoxWidthAbsolute());
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        if(settings.hasFillLab()) builder.setLegendOutsideRightTop(getString(settings, settings.nonNull().getFillLab()));
        else builder.setLegendOutsideRightTop();
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.plotRawSpecialLinePlot(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()));
        return builder;
    }
}
