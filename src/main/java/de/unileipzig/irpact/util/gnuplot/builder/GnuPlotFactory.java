package de.unileipzig.irpact.util.gnuplot.builder;

import de.unileipzig.irpact.util.script.BuilderSettings;

import java.time.LocalDateTime;

/**
 * @author Daniel Abitz
 */
public final class GnuPlotFactory {

    public static final StringSettings SETTINGS = new StringSettings();

    private GnuPlotFactory() {
    }

    private static Comment getAutoGenerated() {
        return new Comment("automatic generated gnuplot script (" + LocalDateTime.now() + ")");
    }

    private static String getUsageComment(int usageFlag) {
        switch (usageFlag) {
            case BuilderSettings.USAGE_ARG0:
                return "usage: gnuplot <scirpt name>";

            case BuilderSettings.USAGE_ARG2:
                return "usage: gnuplot -c <script name> <input file> <output file>";

            case BuilderSettings.NO_USAGE:
            default:
                return null;
        }
    }

    private static void addUsageComment(GnuPlotBuilder builder, int usageFlag) {
        String comment = getUsageComment(usageFlag);
        if(comment != null) {
            builder.addComment(comment);
        }
    }

    private static GnuPlotBuilder newBuilder() {
        GnuPlotBuilder builder = new GnuPlotBuilder();
        builder.setSettings(SETTINGS);
        return builder;
    }

    private static String getString(BuilderSettings settings, String str) {
        if(settings.escapeSpecialCharacters()) {
            return GnuPlotBuilder.escapeUnderscore(str);
        } else {
            return str;
        }
    }

    //=========================
    //line chart
    //=========================

    public static GnuPlotBuilder lineChart0(BuilderSettings settings) {
        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: line chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataLines();
        builder.setLegendOutsideRightTop();
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.printUnknown();
        builder.plotRawSpecialLinePlot(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()), settings.allowNull().getLineWidthInt());
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.setXRange(settings.nonNull().getXMin(), settings.nonNull().getXMax());
        builder.setYRange(settings.nonNull().getYMin(), settings.nonNull().getYMax());
        builder.replot();
        return builder;
    }

    public static GnuPlotBuilder interactionLineChart0(BuilderSettings settings) {
        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: special line chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataLines();
        builder.setLegendOutsideRightTop();
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.printUnknown();
        builder.plotRawSpecialInteractionLinePlot(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()), settings.allowNull().getLineWidthInt());
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.setXRange(settings.nonNull().getXMin(), settings.nonNull().getXMax());
        builder.setYRange(settings.nonNull().getYMin(), settings.nonNull().getYMax());
        builder.replot();
        return builder;
    }

    //=========================
    //stacked bar
    //=========================

    public static GnuPlotBuilder stackedBarChart0(BuilderSettings settings) {
        GnuPlotBuilder builder = newBuilder();
        builder.add(getAutoGenerated());
        builder.addComment("type: stacked bar chart v0");
        addUsageComment(builder, settings.allowNull().getUsageFlag());
        builder.addComment("===style===");
        builder.setStyleDataHistograms();
        builder.setStyleHistrogramRowStacked();
        builder.setFillSolid();
        builder.setBoxWidthAbsolute(settings.allowNull().getBoxWidthAbsolute());
        builder.addComment("===labels===");
        if(settings.hasTitle()) builder.setTitle(getString(settings, settings.nonNull().getTitle()));
        builder.setXLabel(getString(settings, settings.nonNull().getXLab()));
        builder.setYLabel(getString(settings, settings.nonNull().getYLab()));
        if(settings.hasFillLab()) builder.setLegendOutsideRightTop(getString(settings, settings.nonNull().getFillLab()));
        else builder.setLegendOutsideRightTop();
        builder.addComment("===output===");
        builder.printPngCairo();
        builder.setRawOutput(settings.useArgsFlag() ? GnuPlotBuilder.arg(2) : GnuPlotBuilder.quote(settings.getOutputFile()));
        builder.addComment("===plot===");
        builder.setDataFileSeparator(settings.nonNull().getSep());
        builder.plotRawSpecialLinePlot(settings.useArgsFlag() ? GnuPlotBuilder.arg(1) : GnuPlotBuilder.quote(settings.getInputFile()));
        return builder;
    }
}
